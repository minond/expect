#!/bin/bash

#==============================================================================
#         FILE: expect
#  DESCRIPTION: basic assertion method for bash, with TAP output. for info
#               on TAP, visit http://podwiki.hexten.net/TAP/TAP.html
#        USAGE: see usage function
#==============================================================================

EXPECT_OUTPUT_HEADER_DONE=0
EXPECT_FAILED_TESTS=()
EXPECT_TEST_COUNT=0
EXPECT_TOTAL_TEST_COUNT=0

#=== FUNCTION =================================================================
#        NAME: -expect
# DESCRIPTION: an assert method
# PARAMETER 1: test description
# PARAMETER 2: test exit code (defaults to last exit code)
#==============================================================================
-expect() {
    local description=$1
    EXPECT_TEST_COUNT=$((EXPECT_TEST_COUNT + 1))
    echo "ok $EXPECT_TEST_COUNT - # skip $description"
    return 0
}

#=== FUNCTION =================================================================
#        NAME: expect
# DESCRIPTION: an assert method
# PARAMETER 1: test description
# PARAMETER 2: test exit code (defaults to last exit code)
#==============================================================================
expect() {
    local exit_code=$?
    local description=$1
    [ ! -z "$2" ] && exit_code=$2

    EXPECT_TEST_COUNT=$((EXPECT_TEST_COUNT + 1))
    tap:header

    # TAP test line
    if [[ "$exit_code" -eq 0 ]]; then
        echo "ok $EXPECT_TEST_COUNT - $description"
    else
        echo "not ok $EXPECT_TEST_COUNT - $description"
        EXPECT_FAILED_TESTS+=($EXPECT_TEST_COUNT)
    fi

    tap:footer
}

#=== FUNCTION =================================================================
#        NAME: tap:header
# DESCRIPTION: TAP version and plan
#==============================================================================
tap:header() {
    if [ "$EXPECT_OUTPUT_HEADER_DONE" -eq 0 ]; then
        echo "TAP version 13"
        echo "1..$EXPECT_TOTAL_TEST_COUNT"
        EXPECT_OUTPUT_HEADER_DONE=1
    fi
}

#=== FUNCTION =================================================================
#        NAME: tap:footer
# DESCRIPTION: TAP failed tests summary
#==============================================================================
tap:footer() {
    if [ "$EXPECT_TOTAL_TEST_COUNT" -eq "$EXPECT_TEST_COUNT" ] && [ ${#EXPECT_FAILED_TESTS[@]} -ne 0 ]; then
        local save_ifs=$IFS
        local failed_tests_count="${#EXPECT_FAILED_TESTS[@]}"
        local failed_percentage=$(echo "scale=2; 100 - $failed_tests_count * 100 / $EXPECT_TOTAL_TEST_COUNT" | bc)
        local failed_fraction="$failed_tests_count/$EXPECT_TOTAL_TEST_COUNT"

        IFS=","
        local failed_list="${EXPECT_FAILED_TESTS[*]}"
        IFS=$save_ifs

        echo
        echo "FAILED tests $failed_list"
        echo "Failed $failed_fraction tests, $failed_percentage% okay"

        exit 1
    fi
}

#=== FUNCTION =================================================================
#        NAME: tap:counter
# DESCRIPTION: TAP failed tests summary
# PARAMETER 1: file to count tests in
#==============================================================================
tap:counter() {
    local file=$1
    EXPECT_TOTAL_TEST_COUNT=$((
        $(grep -c "^-expect " < "$file") +
        $(grep -c "^expect " < "$file")
    ))
}

tap:counter "$0"
